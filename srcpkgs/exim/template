# Template file for 'exim'
pkgname=exim
version=4.92.3
revision=1
makedepends="libressl-devel pcre-devel db-devel perl pkg-config"
short_desc="Message transfer agent"
maintainer="Orphaned <orphan@voidlinux.org>"
license="GPL-3"
homepage="https://www.exim.org/"
distfiles="ftp://ftp.exim.org/pub/exim/exim4/exim-${version}.tar.xz"
checksum=c4453bb5ec8e16c4c3353769700466eb9aa48c1b2fcf7f3b0e08954dd727d2fd

system_accounts="_exim"
exim_homedir="/var/spool/exim"
provides="smtp-server-0_1"
replaces="smtp-server>=0"
make_dirs="
	/var/spool/exim 750 _exim _exim
	/var/log/exim   755 _exim _exim"
conf_files="/etc/exim/configure"

do_configure() {
	cp src/EDITME Local/Makefile
	cat <<-EOF >> Local/Makefile
		BIN_DIRECTORY=/usr/bin
		CONFIGURE_FILE=/etc/exim/configure
		LOG_FILE_PATH=/var/log/exim/%s
		SPOOL_DIRECTORY=/var/spool/exim

		EXIM_USER=ref:_exim
		EXIM_MONITOR=
		SUPPORT_TLS=yes
		USE_OPENSSL_PC=openssl
		HAVE_IPV6=yes
	EOF
}
 
do_build() {
	make ${makejobs}
}

do_install() {
	#
	# The Exim "install" script doesn't run in the sandbox due
	# to permissions and the (non-existing) _exim UID/GID
	#
	# Other distribution's packages (eg. Fedora) install themselves,
	# and we also do that.
	#

	vlicense LICENCE

	vmkdir usr/lib
	vmkdir etc/exim
	vcopy src/configure.default etc/exim/configure

	cd build-*

	vinstall exim 4755 usr/bin
	ln -s exim ${DESTDIR}/usr/bin/mailq

	# Historically the 'standard' helper for sending mail
	ln -s exim ${DESTDIR}/usr/bin/sendmail
	ln -s ../bin/exim ${DESTDIR}/usr/lib/sendmail

	vinstall ${FILESDIR}/exim.logrotate 0644 etc/logrotate.d exim
	vsv exim
}
